
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // Allow logged-in users to read their own profile and create a profile
    match /users/{userId} {
      allow read, update, delete: if request.auth != null && request.auth.uid == userId;
      allow create: if request.auth != null;
    }
    
    // Allow any authenticated user to list public circles or their own circles
    match /prayerCircles/{document=**} {
        allow read, write: if false; // Default deny
    }

    // Rules for listing the collection of prayer circles
    match /prayerCircles/{circleId} {
      // Allow any authenticated user to list the circles.
      // This is necessary for querying the collection.
      allow list: if request.auth != null;

      // Allow read access to a specific circle if it's public or the user is a member.
      allow read: if request.auth != null && (resource.data.isPublic == true || request.auth.uid in resource.data.members);
      
      // Allow creation if the user is authenticated and is the creator/first member.
      allow create: if request.auth != null && request.resource.data.createdBy == request.auth.uid && request.auth.uid in request.resource.data.members;

      // Allow updates only by the creator (e.g., name, description) or members adding themselves to 'amens' array.
      allow update: if request.auth != null && (
        (request.auth.uid == resource.data.createdBy && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['name', 'description', 'isPublic', 'status', 'victoryTestimony'])) ||
        (request.auth.uid in resource.data.members && (
            request.resource.data.victoryTestimony.amens.size() == resource.data.victoryTestimony.amens.size() + 1 ||
            request.resource.data.members.size() == resource.data.members.size() + 1 // allow joining via invite code
            )
        )
      );
      
      // Allow deletion only by the creator.
      allow delete: if request.auth != null && request.auth.uid == resource.data.createdBy;
    }

    // Rules for prayer requests within a circle
    match /prayerRequests/{requestId} {
      // Allow read/write access only to members of the circle.
      allow read, write: if request.auth != null && exists(/databases/$(database)/documents/prayerCircles/$(resource.data.circleId)) && request.auth.uid in get(/databases/$(database)/documents/prayerCircles/$(resource.data.circleId)).data.members;
    }
    
    // All other collections default to no access.
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
