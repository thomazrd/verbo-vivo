rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // =============================================
    //           FUNÇÕES DE UTILIDADE
    // =============================================

    // --- Funções de Autenticação ---
    function isSignedIn() {
      return request.auth != null;
    }

    function isProfileOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }
    
    function isAdmin() {
      return isSignedIn() && request.auth.token.role == 'ADMIN';
    }

    function isCongregationMember(congregationId) {
      return isSignedIn() && get(/databases/$(database)/documents/congregations/$(congregationId)/members/$(request.auth.uid)).data.status != 'PENDING';
    }
    
    function isCongregationAdmin(congregationId) {
       return isSignedIn() && get(/databases/$(database)/documents/congregations/$(congregationId)/members/$(request.auth.uid)).data.status == 'ADMIN';
    }

    // --- Funções de Validação de Dados ---
    function isString(value) {
      return value is string;
    }

    function isStringSized(value, min, max) {
      return isString(value) && value.size() >= min && value.size() <= max;
    }

    function isBoolean(value) {
      return value is bool;
    }
    
    function isTimestamp(value) {
        return value is timestamp;
    }

    // --- From: articles.rules ---

match /articles/{articleId} {
  // Qualquer pessoa pode ler artigos publicados.
  allow read: if resource.data.status == 'published';

  // Apenas administradores podem criar, atualizar ou deletar artigos.
  allow write: if isAdmin();
}


// --- From: battlePlans.rules ---
// collections/battlePlans.rules

// --- Regras para Planos de Batalha Públicos ---
match /battlePlans/{planId} {
  allow read: if isSignedIn() && resource.data.status == 'PUBLISHED';
  allow create: if isSignedIn(); // Permitir que qualquer usuário autenticado crie um plano
  allow update, delete: if isSignedIn() && request.auth.uid == resource.data.creatorId;

  // As missões são parte do documento do plano, então as regras acima se aplicam.
}

// --- Regras para o Progresso do Usuário nos Planos ---
// Esta regra está aninhada dentro de /users/{userId}
match /users/{userId} {
    // ... outras regras de /users/{userId} podem existir aqui ...

    // Subcoleção para os planos que um usuário iniciou
    match /battlePlans/{planId} {
        allow read, delete: if request.auth.uid == userId;
        allow create, update: if request.auth.uid == userId && request.resource.data.userId == userId;
    }

    // Subcoleção para os logs de missões concluídas
    match /missionLogs/{logId} {
      allow read, write: if request.auth.uid == userId;
    }

    // Regra específica para líderes visualizarem o progresso (fora da subcoleção de usuário)
    match /userBattlePlans/{userPlanId} {
       allow read: if request.auth.uid == resource.data.planCreatorId && resource.data.consentToShareProgress == true;
       // A criação, atualização e exclusão são feitas pelo próprio usuário em /users/{userId}/battlePlans/{planId}, não aqui.
    }
}


// --- From: congregations.rules ---
// Regras para a Coleção de Congregações
match /congregations/{congregationId} {
    // Qualquer usuário logado pode ler os dados da congregação (nome, etc)
    allow read: if isSignedIn();

    // Apenas um usuário logado pode criar uma congregação, e ele deve ser o criador
    allow create: if isSignedIn() && request.auth.uid == request.resource.data.createdBy;

    // Apenas administradores podem atualizar ou deletar a congregação
    allow update, delete: if isCongregationAdmin(congregationId);

    // --- Subcoleção de Membros ---
    match /members/{userId} {
        // Apenas membros da congregação podem ver a lista de outros membros
        allow read, list: if isCongregationMember(congregationId);
        
        // Um usuário pode criar um documento para si mesmo (solicitar entrada)
        allow create: if isSignedIn() && request.auth.uid == userId;

        // Apenas admins podem atualizar o status de um membro (aprovar, etc)
        allow update: if isCongregationAdmin(congregationId);
        
        // Admins podem remover membros, e um membro pode sair
        allow delete: if isCongregationAdmin(congregationId) || request.auth.uid == userId;
    }

    // --- Subcoleção de Posts ---
    match /posts/{postId} {
        // Apenas membros podem ler os posts
        allow read: if isCongregationMember(congregationId);

        // Um membro pode criar um post para si mesmo.
        allow create: if isCongregationMember(congregationId) && request.auth.uid == request.resource.data.authorId;
        
        // Apenas o autor do post pode atualizar ou deletar o post.
        allow update, delete: if isProfileOwner(resource.data.authorId);

        // --- Subcoleção de Comentários ---
        match /comments/{commentId} {
            // Todos os membros podem ler os comentários
            allow read: if isCongregationMember(congregationId);

            // QUALQUER membro da congregação pode criar um comentário.
            allow create: if isCongregationMember(congregationId) && request.auth.uid == request.resource.data.authorId;

            // Apenas o AUTOR do comentário pode editar ou apagar.
            allow update, delete: if isProfileOwner(resource.data.authorId);
        }

        // --- Subcoleção de Likes ---
        match /likes/{userId} {
             // Todos os membros podem ver quem curtiu.
            allow read: if isCongregationMember(congregationId);

            // Um membro só pode criar ou deletar a sua própria curtida.
            allow create, delete: if isCongregationMember(congregationId) && request.auth.uid == userId;
        }
    }
}


// --- From: sharedArmors.rules ---

match /sharedArmors/{armorId} {
  allow read: if true;
  allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;
  allow update, delete: if isSignedIn() && resource.data.userId == request.auth.uid;
}


// --- From: studies.rules ---

match /studies/{studyId} {
  // Qualquer pessoa pode ler um estudo publicado.
  allow read: if resource.data.status == 'PUBLISHED';

  // Apenas administradores podem criar, atualizar ou deletar estudos.
  allow write: if isAdmin();
}


// --- From: users.rules ---

match /users/{userId} {
  // Qualquer usuário autenticado pode ler perfis (para ver nomes, fotos, etc).
  allow read: if isSignedIn();
  
  // Apenas o próprio usuário pode escrever em seu perfil.
  allow write: if isProfileOwner(userId);

  // Subcoleção de planos de estudo
  match /plans/{planId} {
    // Apenas o dono do perfil pode acessar seus próprios planos.
    allow read, write, delete: if isProfileOwner(userId);
  }
  
  // Subcoleção de armaduras
  match /armors/{armorId} {
     // Apenas o dono do perfil pode acessar suas próprias armaduras.
    allow read, write, delete: if isProfileOwner(userId);
  }
}

// Armaduras compartilhadas podem ser lidas por qualquer usuário autenticado.
match /sharedArmors/{armorId} {
    allow read: if isSignedIn();
    // A escrita (criar/atualizar/deletar) é gerenciada pelo dono na sua própria coleção /users/{userId}/armors
    allow write: if false;
}
  }
}
