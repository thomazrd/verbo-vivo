rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // =============================================
    //           FUNÇÕES DE UTILIDADE
    // =============================================

    // --- Funções de Autenticação ---
    function isSignedIn() {
      return request.auth != null;
    }

    function isProfileOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }
    
    function isAdmin() {
      return isSignedIn() && request.auth.token.role == 'ADMIN';
    }

    function isCongregationMember(congregationId) {
      return isSignedIn() && get(/databases/$(database)/documents/congregations/$(congregationId)/members/$(request.auth.uid)).data.status != 'PENDING';
    }
    
    function isCongregationAdmin(congregationId) {
       return isSignedIn() && get(/databases/$(database)/documents/congregations/$(congregationId)/members/$(request.auth.uid)).data.status == 'ADMIN';
    }

    // --- Funções de Validação de Dados ---
    function isString(value) {
      return value is string;
    }

    function isStringSized(value, min, max) {
      return isString(value) && value.size() >= min && value.size() <= max;
    }

    function isBoolean(value) {
      return value is bool;
    }
    
    function isTimestamp(value) {
        return value is timestamp;
    }

    // --- From: articles.rules ---

match /articles/{articleId} {
  // Qualquer pessoa pode ler artigos publicados.
  allow read: if resource.data.status == 'published';

  // Apenas administradores podem criar, atualizar ou deletar artigos.
  allow write: if isAdmin();
}


// --- From: battlePlans.rules ---
// collections/battlePlans.rules

match /battlePlans/{planId} {
  // Leitura: Qualquer usuário autenticado pode ler planos publicados OU se for o criador do plano.
  allow read: if isSignedIn() && (resource.data.status == 'PUBLISHED' || resource.data.creatorId == request.auth.uid);

  // Criação: Qualquer usuário autenticado pode criar um plano (será um líder).
  allow create: if isSignedIn();

  // Atualização e Exclusão: Apenas o criador original do plano pode modificar ou apagar.
  allow update, delete: if isSignedIn() && resource.data.creatorId == request.auth.uid;
}

// Subcoleção de 'users' que armazena o progresso dos planos daquele usuário
match /users/{userId}/battlePlans/{userPlanId} {
  // Leitura: Um usuário pode ler seu próprio progresso.
  // Um LÍDER pode ler o progresso de um soldado SE o soldado deu consentimento.
  allow read: if isOwner(userId) ||
              (isSignedIn() && resource.data.consentToShareProgress == true &&
               request.auth.uid == resource.data.planCreatorId);

  // Criação: Um usuário pode criar seu próprio registro de progresso (iniciar um plano).
  allow create: if isOwner(userId);

  // Atualização: Um usuário só pode atualizar seu próprio progresso.
  allow update: if isOwner(userId);

  // Exclusão: Um usuário só pode apagar seu próprio progresso.
  allow delete: if isOwner(userId);
}

// Logs de missão são privados
match /missionLogs/{logId} {
  allow read, write: if isSignedIn() && request.resource.data.userId == request.auth.uid;
}


// --- From: congregations.rules ---
// Regras para a Coleção de Congregações
match /congregations/{congregationId} {
    // Qualquer usuário logado pode ler os dados da congregação (nome, etc)
    allow read: if isSignedIn();

    // Apenas um usuário logado pode criar uma congregação, e ele deve ser o criador
    allow create: if isSignedIn() && request.auth.uid == request.resource.data.createdBy;

    // Apenas administradores podem atualizar ou deletar a congregação
    allow update, delete: if isCongregationAdmin(congregationId);

    // --- Subcoleção de Membros ---
    match /members/{userId} {
        // Apenas membros da congregação podem ver a lista de outros membros
        allow read, list: if isCongregationMember(congregationId);
        
        // Um usuário pode criar um documento para si mesmo (solicitar entrada)
        allow create: if isSignedIn() && request.auth.uid == userId;

        // Apenas admins podem atualizar o status de um membro (aprovar, etc)
        allow update: if isCongregationAdmin(congregationId);
        
        // Admins podem remover membros, e um membro pode sair
        allow delete: if isCongregationAdmin(congregationId) || request.auth.uid == userId;
    }

    // --- Subcoleção de Posts ---
    match /posts/{postId} {
        // Apenas membros podem ler os posts
        allow read: if isCongregationMember(congregationId);

        // Um membro pode criar um post para si mesmo.
        allow create: if isCongregationMember(congregationId) && request.auth.uid == request.resource.data.authorId;
        
        // Apenas o autor do post pode atualizar ou deletar o post.
        allow update, delete: if isProfileOwner(resource.data.authorId);

        // --- Subcoleção de Comentários ---
        match /comments/{commentId} {
            // Todos os membros podem ler os comentários
            allow read: if isCongregationMember(congregationId);

            // QUALQUER membro da congregação pode criar um comentário.
            allow create: if isCongregationMember(congregationId) && request.auth.uid == request.resource.data.authorId;

            // Apenas o AUTOR do comentário pode editar ou apagar.
            allow update, delete: if isProfileOwner(resource.data.authorId);
        }

        // --- Subcoleção de Likes ---
        match /likes/{userId} {
             // Todos os membros podem ver quem curtiu.
            allow read: if isCongregationMember(congregationId);

            // Um membro só pode criar ou deletar a sua própria curtida.
            allow create, delete: if isCongregationMember(congregationId) && request.auth.uid == userId;
        }
    }
}


// --- From: journals.rules ---
// Regras para a coleção 'journals'

match /journals/{journalId} {
  // Permite que um usuário liste apenas as suas próprias entradas no diário.
  // A consulta DEVE incluir a cláusula `where('userId', '==', request.auth.uid)`.
  allow list: if request.auth != null;

  // Permite que um usuário leia, atualize ou delete um documento específico
  // apenas se ele for o proprietário (o userId no documento é o mesmo do usuário autenticado).
  allow get, update, delete: if request.auth != null && request.auth.uid == resource.data.userId;

  // Permite a criação se o novo documento pertencer ao usuário que o está criando.
  allow create: if request.auth != null && request.auth.uid == request.resource.data.userId;
}


// --- From: missionLogs.rules ---

// Regras para a coleção que registra a conclusão de cada missão
match /missionLogs/{logId} {
  // Permite que um usuário crie um log se o ID do usuário no documento for o seu.
  allow create: if request.auth != null && request.resource.data.userId == request.auth.uid;
  // Permite que um usuário leia, atualize ou delete seus próprios logs de missão.
  allow read, update, delete: if request.auth != null && resource.data.userId == request.auth.uid;
}


// --- From: notifications.rules ---

// Permite que um usuário leia uma notificação apenas se for o destinatário.
// Ninguém pode escrever ou apagar notificações pelo lado do cliente.
match /notifications/{notificationId} {
  allow read: if request.auth.uid == resource.data.recipientId;
  allow write, delete: if false;
}


// --- From: sharedArmors.rules ---

match /sharedArmors/{armorId} {
  allow read: if true;
  allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;
  allow update, delete: if isSignedIn() && resource.data.userId == request.auth.uid;
}


// --- From: studies.rules ---

match /studies/{studyId} {
  // Qualquer pessoa pode ler um estudo publicado.
  allow read: if resource.data.status == 'PUBLISHED';

  // Apenas administradores podem criar, atualizar ou deletar estudos.
  allow write: if isAdmin();
}


// --- From: userBattlePlans.rules ---

// Regras para a subcoleção que armazena o progresso de um usuário em um plano.
match /users/{userId}/battlePlans/{userPlanId} {
  // Um usuário pode ler, criar, atualizar e apagar seu próprio progresso de plano.
  allow read, write: if request.auth != null && request.auth.uid == userId;

  // TODO: Adicionar regra para que o criador do plano possa LER (mas não escrever)
  // o progresso se o usuário consentir.
}


// --- From: users.rules ---

match /users/{userId} {
  // Qualquer usuário autenticado pode ler perfis (para ver nomes, fotos, etc).
  allow read: if isSignedIn();
  
  // Apenas o próprio usuário pode escrever em seu perfil.
  allow write: if isProfileOwner(userId);

  // Subcoleção de planos de estudo
  match /plans/{planId} {
    // Apenas o dono do perfil pode acessar seus próprios planos.
    allow read, write, delete: if isProfileOwner(userId);
  }
  
  // Subcoleção de armaduras
  match /armors/{armorId} {
     // Apenas o dono do perfil pode acessar suas próprias armaduras.
    allow read, write, delete: if isProfileOwner(userId);
  }
}

// Armaduras compartilhadas podem ser lidas por qualquer usuário autenticado.
match /sharedArmors/{armorId} {
    allow read: if isSignedIn();
    // A escrita (criar/atualizar/deletar) é gerenciada pelo dono na sua própria coleção /users/{userId}/armors
    allow write: if false;
}
  }
}
