
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Regras de Usuários
    match /users/{userId} {
      allow read: if request.auth != null;
      allow create: if request.auth.uid == userId;
      allow update: if request.auth.uid == userId;
    }

    // Regras do Chat
    match /users/{userId}/messages/{messageId} {
      allow read, write: if request.auth.uid == userId;
    }

    // Regras dos Círculos de Oração
    match /prayerCircles {
      allow list: if request.auth != null;
    }

    match /prayerCircles/{circleId} {
      allow read: if request.auth != null && (resource.data.isPublic == true || request.auth.uid in resource.data.members);
      allow create: if request.auth != null && request.resource.data.createdBy == request.auth.uid && request.auth.uid in request.resource.data.members;
      allow update: if request.auth != null && (
        (request.auth.uid == resource.data.createdBy && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['name', 'description', 'status', 'victoryTestimony'])) ||
        (request.auth.uid in resource.data.members && request.resource.data.victoryTestimony.amens.size() == resource.data.victoryTestimony.amens.size() + 1)
      );
      allow delete: if request.auth != null && request.auth.uid == resource.data.createdBy;
    }

    // Regras dos Pedidos de Oração
    match /prayerRequests/{requestId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null && request.resource.data.authorId == request.auth.uid;
      allow update: if request.auth != null && (request.auth.uid == resource.data.authorId || request.resource.data.diff(resource.data).affectedKeys().hasOnly(['prayingUsers']));
      allow delete: if request.auth != null && request.auth.uid == resource.data.authorId;
    }

    // Regras do Diário
    match /journals/{entryId} {
        allow read, write: if request.auth.uid == resource.data.userId;
    }

    // Regras das Notificações
    match /notifications/{notificationId} {
        allow read, update: if request.auth.uid == resource.data.recipientId;
    }

    // Regras dos Planos de Estudo
    match /users/{userId}/plans/{planId} {
      allow read, write, delete: if request.auth.uid == userId;
    }
  }
}
