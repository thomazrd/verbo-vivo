// collections/battlePlans.rules

// --- Regras para Planos de Batalha Públicos ---
match /battlePlans/{planId} {
  allow read: if isSignedIn() && resource.data.status == 'PUBLISHED';
  allow create: if isSignedIn(); // Permitir que qualquer usuário autenticado crie um plano
  allow update, delete: if isSignedIn() && request.auth.uid == resource.data.creatorId;

  // As missões são parte do documento do plano, então as regras acima se aplicam.
}

// --- Regras para o Progresso do Usuário nos Planos ---
// Esta regra está aninhada dentro de /users/{userId}
match /users/{userId} {
    // ... outras regras de /users/{userId} podem existir aqui ...

    // Subcoleção para os planos que um usuário iniciou
    match /battlePlans/{planId} {
        allow read, delete: if request.auth.uid == userId;
        allow create, update: if request.auth.uid == userId && request.resource.data.userId == userId;
    }

    // Subcoleção para os logs de missões concluídas
    match /missionLogs/{logId} {
      allow read, write: if request.auth.uid == userId;
    }

    // Regra específica para líderes visualizarem o progresso (fora da subcoleção de usuário)
    match /userBattlePlans/{userPlanId} {
       allow read: if request.auth.uid == resource.data.planCreatorId && resource.data.consentToShareProgress == true;
       // A criação, atualização e exclusão são feitas pelo próprio usuário em /users/{userId}/battlePlans/{planId}, não aqui.
    }
}
