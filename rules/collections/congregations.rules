match /congregations/{congregationId} {
  allow read: if isSignedIn();
  allow create: if isSignedIn();
  allow update: if isCongregationAdmin(congregationId);

  // --- Membros da Congregação ---
  match /members/{userId} {
    allow read: if isCongregationMember(congregationId);
    allow create: if request.auth.uid == userId; // Solicitar entrada
    allow update: if isCongregationAdmin(congregationId) || request.auth.uid == userId; // Admin aprova, ou usuário sai
    allow delete: if isCongregationAdmin(congregationId) || request.auth.uid == userId; // Admin remove, ou usuário sai
  }

  // --- Posts da Congregação ---
  match /posts/{postId} {
    allow read: if isCongregationMember(congregationId);
    
    // PERMITE a criação de documentos em subcoleções (comentários, likes) por membros.
    allow write: if isCongregationMember(congregationId);
    
    // RESTRINGE a atualização e exclusão do próprio post ao seu autor.
    allow update, delete: if isProfileOwner(resource.data.authorId);

    // --- Comentários nos Posts ---
    match /comments/{commentId} {
      allow read: if isCongregationMember(congregationId);
      allow create: if isCongregationMember(congregationId);
      allow update, delete: if isProfileOwner(resource.data.authorId);
    }

    // --- Likes nos Posts ---
    match /likes/{userId} {
      allow read: if isCongregationMember(congregationId);
      allow create, delete: if request.auth.uid == userId;
    }
  }
}
