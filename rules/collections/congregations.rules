
match /congregations/{congregationId} {
  function isCongregationMember(congregationId) {
    return isSignedIn() && get(/databases/$(database)/documents/congregations/$(congregationId)/members/$(request.auth.uid)).data.status in ['MEMBER', 'ADMIN'];
  }

  function isCongregationAdmin(congregationId) {
     return isSignedIn() && get(/databases/$(database)/documents/congregations/$(congregationId)/members/$(request.auth.uid)).data.status == 'ADMIN';
  }

  allow read: if isSignedIn() && isCongregationMember(congregationId);

  // Posts
  match /posts/{postId} {
    allow read: if isCongregationMember(congregationId);
    allow create: if isCongregationMember(congregationId) && request.auth.uid == request.resource.data.authorId;
    allow update: if isCongregationMember(congregationId) && request.auth.uid == resource.data.authorId;
    allow delete: if isCongregationMember(congregationId) && (request.auth.uid == resource.data.authorId || isCongregationAdmin(congregationId));

    // Comments
    match /comments/{commentId} {
      allow read: if isCongregationMember(congregationId);
      allow create: if isCongregationMember(congregationId);
      allow update, delete: if isCongregationMember(congregationId) && request.auth.uid == resource.data.authorId;
    }

    // Likes
    match /likes/{userId} {
      allow read: if isCongregationMember(congregationId);
      allow create, delete: if isCongregationMember(congregationId) && request.auth.uid == userId;
    }
  }

  // Members
  match /members/{memberId} {
    allow read: if isCongregationMember(congregationId);
    allow create: if isSignedIn(); // Allow any signed-in user to request to join
    allow update: if isCongregationAdmin(congregationId); // Only admins can change member status
    allow delete: if isCongregationAdmin(congregationId) || request.auth.uid == memberId; // Admins or the user themselves can leave/be removed
  }
}
