match /congregations/{congregationId} {
  allow read: if isSignedIn();
  allow create: if request.auth.uid == request.resource.data.createdBy;

  // Membros de uma congregação
  match /members/{userId} {
    allow read: if isCongregationMember(congregationId);
    allow create: if request.auth.uid == userId; // Ao solicitar entrada
    allow update: if isCongregationAdmin(congregationId); // Admins podem aprovar/promover
    allow delete: if request.auth.uid == userId || isCongregationAdmin(congregationId); // Usuário pode sair, admin pode remover
  }

  // Posts dentro de uma congregação
  match /posts/{postId} {
    allow read: if isCongregationMember(congregationId);
    // Apenas o autor do post pode criar, editar ou deletar o próprio post.
    // A escrita em subcoleções (como comentários) é governada pelas próprias regras.
    allow create, update, delete: if isProfileOwner(request.resource.data.authorId);

    // Comentários dentro de um post
    match /comments/{commentId} {
      allow read: if isCongregationMember(congregationId);
      // CORREÇÃO: Qualquer membro pode criar um comentário.
      allow create: if isCongregationMember(congregationId);
      // APENAS o autor do comentário pode editar ou deletar.
      allow update, delete: if isProfileOwner(resource.data.authorId);

      // Likes em comentários
      match /likes/{userId} {
        allow read: if isCongregationMember(congregationId);
        allow create, delete: if request.auth.uid == userId;
      }
    }
    
    // Likes em posts
    match /likes/{userId} {
      allow read: if isCongregationMember(congregationId);
      allow create, delete: if request.auth.uid == userId;
    }
  }
}
