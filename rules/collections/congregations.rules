
// --- /congregations/{congregationId} ---
match /congregations/{congregationId} {
    allow read: if isSignedIn();
    allow create: if isSignedIn() && request.auth.uid == request.resource.data.createdBy;
    allow update: if isCongregationAdmin(congregationId);
    allow delete: if isCongregationAdmin(congregationId);

    // --- Sub-collection de Membros ---
    match /members/{userId} {
        allow read, list: if isCongregationMember(congregationId);
        allow create: if isSignedIn() && request.auth.uid == userId; // User requesting to join
        allow update: if isCongregationAdmin(congregationId); // Admins approving/promoting
        allow delete: if isCongregationAdmin(congregationId) || request.auth.uid == userId; // Admins removing or user leaving
    }

    // --- Sub-collection de Posts ---
    match /posts/{postId} {
        allow read: if isCongregationMember(congregationId);
        
        // CREATE: Any member can create a post.
        allow create: if isCongregationMember(congregationId) && request.auth.uid == request.resource.data.authorId;
        
        // UPDATE/DELETE: Only the author of the post can update or delete it.
        allow update, delete: if isProfileOwner(resource.data.authorId);

        // --- Sub-coleção de Comentários ---
        match /comments/{commentId} {
            allow read: if isCongregationMember(congregationId);
            
            // CREATE: Any member of the congregation can create a comment.
            allow create: if isCongregationMember(congregationId) && request.auth.uid == request.resource.data.authorId;

            // UPDATE/DELETE: Only the author of the specific comment can edit or delete it.
            allow update, delete: if isProfileOwner(resource.data.authorId);
        }

        // --- Sub-coleção de Likes ---
        match /likes/{userId} {
            allow read: if isCongregationMember(congregationId);
            
            // CREATE/DELETE: A user can only manage their own like.
            allow create, delete: if isCongregationMember(congregationId) && request.auth.uid == userId;
        }
    }
}
