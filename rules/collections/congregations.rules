match /congregations/{congregationId} {
  allow read: if isCongregationMember(congregationId);
  allow create: if isSignedIn();
  allow update: if isCongregationAdmin(congregationId);

  match /members/{userId} {
    allow read: if isCongregationMember(congregationId);
    allow create: if isSignedIn(); // Handled by a cloud function
    allow update, delete: if isCongregationAdmin(congregationId) || isProfileOwner(userId);
  }

  match /posts/{postId} {
    // Permitir leitura a todos os membros e criação também (para viabilizar a escrita em subcoleções como comments)
    allow read, create: if isCongregationMember(congregationId);
    // Permitir update e delete apenas ao autor do post
    allow update, delete: if isProfileOwner(resource.data.authorId);

    match /likes/{userId} {
      allow read: if isCongregationMember(congregationId);
      allow create, delete: if isProfileOwner(userId);
    }
    
    match /comments/{commentId} {
      allow read: if isCongregationMember(congregationId);
      // Qualquer membro pode criar um comentário
      allow create: if isCongregationMember(congregationId);
      // Apenas o autor do comentário pode editar ou apagar
      allow update, delete: if isProfileOwner(request.auth.uid);
    }
  }
}
