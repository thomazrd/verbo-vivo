// Regras para a Coleção de Congregações
match /congregations/{congregationId} {
    // Qualquer usuário logado pode ler os dados da congregação (nome, etc)
    allow read: if isSignedIn();

    // Apenas um usuário logado pode criar uma congregação, e ele deve ser o criador
    allow create: if isSignedIn() && request.auth.uid == request.resource.data.createdBy;

    // Apenas administradores podem atualizar ou deletar a congregação
    allow update, delete: if isCongregationAdmin(congregationId);

    // --- Subcoleção de Membros ---
    match /members/{userId} {
        // Apenas membros da congregação podem ver a lista de outros membros
        allow read, list: if isCongregationMember(congregationId);
        
        // Um usuário pode criar um documento para si mesmo (solicitar entrada)
        allow create: if isSignedIn() && request.auth.uid == userId;

        // Apenas admins podem atualizar o status de um membro (aprovar, etc)
        allow update: if isCongregationAdmin(congregationId);
        
        // Admins podem remover membros, e um membro pode sair
        allow delete: if isCongregationAdmin(congregationId) || request.auth.uid == userId;
    }

    // --- Subcoleção de Posts ---
    match /posts/{postId} {
        // Apenas membros podem ler os posts
        allow read: if isCongregationMember(congregationId);

        // Um membro pode criar um post para si mesmo.
        allow create: if isCongregationMember(congregationId) && request.auth.uid == request.resource.data.authorId;
        
        // Apenas o autor do post pode atualizar ou deletar o post.
        allow update, delete: if isProfileOwner(resource.data.authorId);

        // --- Subcoleção de Comentários ---
        match /comments/{commentId} {
            // Todos os membros podem ler os comentários
            allow read: if isCongregationMember(congregationId);

            // QUALQUER membro da congregação pode criar um comentário.
            allow create: if isCongregationMember(congregationId) && request.auth.uid == request.resource.data.authorId;

            // Apenas o AUTOR do comentário pode editar ou apagar.
            allow update, delete: if isProfileOwner(resource.data.authorId);
        }

        // --- Subcoleção de Likes ---
        match /likes/{userId} {
             // Todos os membros podem ver quem curtiu.
            allow read: if isCongregationMember(congregationId);

            // Um membro só pode criar ou deletar a sua própria curtida.
            allow create, delete: if isCongregationMember(congregationId) && request.auth.uid == userId;
        }
    }
}
