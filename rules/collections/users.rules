match /users/{userId} {
  // Leitura: Qualquer usuário autenticado pode ler perfis públicos.
  // Escrita: O próprio usuário ou um administrador podem escrever.
  allow read: if isSignedIn();
  allow write: if isUser(userId) || isAdmin();

  // Regras para subcoleções de 'users' (ex: planos de estudo, armaduras)
  // Geralmente, o usuário só pode acessar seus próprios dados.
  match /plans/{planId} {
    allow read, write, delete: if isUser(userId);
  }

  match /armors/{armorId} {
    allow read, write, delete: if isUser(userId);
  }

  match /battlePlans/{userPlanId} {
    // A leitura do progresso do usuário pode ser permitida para o líder do plano.
    allow read: if isUser(userId) || 
                (isSignedIn() && resource.data.consentToShareProgress == true && get(/databases/$(database)/documents/battlePlans/$(resource.data.planId)).data.creatorId == request.auth.uid);
    allow create, update, delete: if isUser(userId);
  }
}
