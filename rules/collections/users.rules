match /users/{userId} {
  allow read: if isSignedIn();
  allow write: if isUser(userId) || isAdmin();

  // Regras para subcoleções de 'users'
  match /messages/{messageId} {
    allow read, write: if isUser(userId);
  }
  
  match /plans/{planId} {
    allow read, write: if isUser(userId);
  }

  match /armors/{armorId} {
      allow read, write: if isUser(userId);
  }

  match /battlePlans/{userPlanId} {
    // Leitura: Um usuário pode ler seu próprio progresso.
    // Um LÍDER pode ler o progresso de um soldado SE o soldado deu consentimento.
    allow read: if isUser(userId) ||
                (isSignedIn() && resource.data.consentToShareProgress == true &&
                get(/databases/$(database)/documents/battlePlans/$(resource.data.planId)).data.creatorId == request.auth.uid);

    // Criação: Um usuário pode criar seu próprio registro de progresso (iniciar um plano).
    allow create: if isUser(userId);

    // Atualização: Um usuário só pode atualizar seu próprio progresso.
    allow update: if isUser(userId);

    // Exclusão: Um usuário só pode apagar seu próprio progresso.
    allow delete: if isUser(userId);
  }
}
